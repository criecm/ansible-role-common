---
# get jail status
- name: get jail status
  command: 'sysctl -n security.jail.jailed'
  failed_when: False
  check_mode: False
  changed_when: False
  register: jail_status

- name: register is_jail
  set_fact:
    is_jail: True
  when: jail_status.rc == 0 and jail_status.stdout == "1"

- name: get vm guest status
  command: 'sysctl -n kern.vm_guest'
  failed_when: False
  check_mode: False
  changed_when: False
  register: vm_status

- name: register is_vm
  set_fact:
    is_vm: True
  when: ( vm_status.rc == 0 and vm_status.stdout != "none" ) or (jail_status.rc == 0 and jail_status.stdout == "1")

# packages ecm
- block:
  - name: mkdir pkgrepo
    file:
      path: /usr/local/etc/pkg/repos
      state: directory
      mode: '0755'
  
  - name: pkg repo ecm
    copy:
      src: '{{ pkg_repo_conf }}'
      dest: '/usr/local/etc/pkg/repos/{{ pkg_repo_conf | regex_replace(".*/", "") }}'
      validate: 'pkg -vv -C %s'
      mode: '0644'
  when: pkg_repo_conf != '' and do_sysadm
  tags: baseconf, pkg

# packages standard
- name: pkgs standard
  pkgng:
    name: '{{item}}'
    state: present
  with_items:
    - git
    - rsync
    - tmux
    - vim-lite
    - zsh
    - munin-node
    - openldap-sasl-client
    - '{{ pkgs }}'
    - '{{ role_pkgs }}'
    - '{{ host_pkgs }}'
  tags: baseconf, pkg

- name: pkgs pkg machine physique
  pkgng:
    name: '{{item}}'
    state: present
  with_items:
    - bsnmp-ucd
    - dmidecode
    - ipmitool
    - smartmontools
  when: not is_jail and not is_vm and do_sysadm
  tags: baseconf, pkg

# mail via relay
- name: mailrelay
  lineinfile:
    dest: /etc/mail/freebsd.submit.mc
    line: "FEATURE(`msp', `[{{mailrelay}}]')"
    regexp: '^FEATURE\(.?msp'
  register: domailrelay
  when: mailrelay != '' and not is_mailrelay and do_sysadm
  tags: baseconf, mailclient

- block:
  - name: stop sendmail
    service:
      name: sendmail
      state: stopped

  - name: config relay sendmail
    command: /usr/bin/make install-submit-cf
    args:
      chdir: /etc/mail

  - name: no sendmail_submit
    lineinfile:
      dest: /etc/rc.conf
      line: 'sendmail_submit_enable="NO"'
      regexp: '^sendmail_submit_enable='

  when: domailrelay.changed == True
  tags: baseconf mailclient

# timezone
- block:
  - name: get timezone
    command: cat /var/db/zoneinfo
    register: zoneinfo
    changed_when: False
    ignore_errors: True
    check_mode: False
  - name: set timezone
    command: 'tzsetup {{ host_timezone }}'
    when: zoneinfo.stdout != host_timezone and do_sysadm
  tags: baseconf, timezone

# syslog
- block:
  - name: syslog central
    lineinfile:
      dest: /etc/syslog.conf
      line: '*.*			@{{ syslog_server }}'
      regexp: '^\*.\*\s+@.*'
      insertafter: '^#\*\.\*'
    notify: restart BSD syslogd
  - name: syslog centrale auth
    lineinfile:
      dest: /etc/syslog.conf
      line: 'auth.info;authpriv.info			@{{ syslog_auth_server }}'
      regexp: '^auth.*@.*'
      insertafter: '^\*.\*\s+@.*'
    notify: restart BSD syslogd
  - name: console.log
    lineinfile:
      dest: /etc/syslog.conf
      line: 'console.info       /var/log/console.log'
      regexp: '.*console.log'
      insertafter: 'console.log'
    notify: touch console.log
  - name: get rc flags
    command: 'sysrc -n syslogd_flags'
    register: sysrc_syslogd_flags
    changed_when: False
    check_mode: False
  - name: set syslogd_flags
    command: 'sysrc syslogd_flags="-c -s"'
    when: sysrc_syslogd_flags.stdout != "-c -s"
  when: syslog_server != '' and not is_syslogd and do_sysadm
  tags: baseconf, syslog

# hardening freebsd
- block:
  - name: rc.conf
    lineinfile:
      dest: /etc/rc.conf
      regexp: '{{item.regexp}}'
      line: '{{item.line}}'
    with_items:
      - { regexp: '^clear_tmp_enable=', line: 'clear_tmp_enable="YES"' }
  - name:
    lineinfile:
      dest: /etc/sysctl.conf
      regexp: '{{item.regexp}}'
      line: '{{item.line}}'
    with_items:
      - { regexp: '^security.bsd.see_other_uids=', line: 'security.bsd.see_other_uids=0' }
    when: 'freebsd_allow_see_other | default(False)'
  tags: baseconf, security
  when: do_sysadm or do_ssi

# ocsinventory
- block:
  - name: install ocsinventory-agent
    pkgng:
      name: Ocsinventory-Unix-Agent
      state: present
  - file:
      dest: /usr/local/etc/ocsinventory
      state: directory
  - name: config
    copy:
      dest: /usr/local/etc/ocsinventory/ocsinventory-agent.cfg
      content: |
        server={{ ocsinventory_server }}
        ca=/usr/local/etc/ssl/cert.pem
        basevardir=/var/db/ocsinventory-agent
        {% if ocsinventory_tag %}tag={{ ocsinventory_tag }}{% endif %}
  - name: run ocsinventory-agent
    command: '/usr/local/bin/ocsinventory-agent'
    failed_when: False
    changed_when: False
  tags: ocsinventory
  when: ocsinventory_server != "" and not is_jail and not is_vm and do_sysadm

# snmp
- name: config snmpd
  lineinfile:
    line: '{{ item.line }}'
    regexp: '{{ item.regexp }}'
    dest: /etc/snmpd.config
  with_items:
    - { line: 'begemotSnmpdModulePath."ucd" = "/usr/local/lib/snmp_ucd.so"', regexp: '^begemotSnmpdModulePath.*snmp_ucd' }
#    - { line: 'begemotSnmpdModulePath."hostres" = "/usr/lib/snmp_hostres.so"', regexp: '^begemotSnmpdModulePath.*snmp_hostres' }
  notify: restart bsnmpd
  when: not is_jail and not is_vm and do_sysadm
  tags: baseconf, snmpd

# ntp leapfile
- name: leapfile
  lineinfile:
    line: 'daily_ntpd_leapfile_enable="NO"'
    regexp: '^daily_ntpd_leapfile_enable='
    insertafter: 'daily_ntpd_leapfile_enable'
    dest: /etc/periodic.conf
    create: True
  when: not is_jail and not is_vm and do_sysadm
  tags: baseconf, ntpd

- name: enable bsnmpd
  service:
    name: bsnmpd
    state: started
    enabled: yes
  when: not is_jail and not is_vm and do_sysadm
  tags: baseconf, snmpd

# NUT
- block:
  - name: install NUT
    pkgng:
      name: nut
      state: present
    tags: pkg, ups
  - name: nut.conf
    copy:
      content: |
        MODE={{ nut_mode }}
      dest: /usr/local/etc/nut/nut.conf
    tags: conf, ups
  - name: upsmon.conf
    template:
      src: upsmon.conf.j2
      dest: /usr/local/etc/nut/upsmon.conf
      mode: '0640'
    tags: conf, ups
  - name: service upsmon
    service:
      name: nut_upsmon
      state: started
      enabled: True
    tags: ups
  when: nut_monitor != "" and not is_vm and not is_jail and do_sysadm
